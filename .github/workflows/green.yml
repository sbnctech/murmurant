name: green

# ==============================================================================
# THE GREEN GATE - Required for all PRs
# ==============================================================================
#
# This is the single, fast, deterministic check that must pass before merge.
#
# What it runs (~30-60 seconds):
#   1. typecheck   - TypeScript compilation
#   2. lint        - ESLint static analysis
#   3. guardrails  - Auth/impersonation safety checks
#   4. test:unit   - Vitest unit tests (including contracts)
#
# What it does NOT run (see green:e2e / green:full):
#   - Playwright browser tests (slow, flaky risk)
#   - Database seeding
#
# Why this is enough:
#   - Type errors caught at compile time
#   - Lint catches common bugs and style issues
#   - Guardrails enforce security invariants (impersonation, auth)
#   - Unit tests cover business logic deterministically
#
# For full E2E coverage, use: npm run green:full
#
# Docs: docs/CI/GREEN_GATE.md
# ==============================================================================

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: green-${{ github.ref }}
  cancel-in-progress: true

jobs:
  green:
    name: green
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ========== Fast Gate Steps ==========
      - name: TypeScript check
        id: typecheck
        run: npm run typecheck

      - name: Lint
        id: lint
        run: npm run lint

      - name: Guardrails
        id: guardrails
        run: npm run test:guardrails

      - name: Unit tests
        id: unit
        run: npm run test:unit

      # ========== Summary ==========
      - name: Generate summary
        if: always()
        run: |
          echo "## Green Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ steps.typecheck.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ steps.lint.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Guardrails | ${{ steps.guardrails.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ steps.unit.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What This Covers" >> $GITHUB_STEP_SUMMARY
          echo "- **TypeScript**: Compilation errors, type safety" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint**: ESLint static analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Guardrails**: Auth/impersonation safety (security invariants)" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests**: Vitest tests (including contracts)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Not Included (use \`green:full\`)" >> $GITHUB_STEP_SUMMARY
          echo "- Playwright browser tests" >> $GITHUB_STEP_SUMMARY
          echo "- Database seeding" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– Docs: docs/CI/GREEN_GATE.md" >> $GITHUB_STEP_SUMMARY
